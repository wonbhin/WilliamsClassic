<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WilliamsClassic</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0b0e11; 
            --card: #1e2329; 
            --text: #eaecef; 
            --green: #0ecb81; 
            --red: #f6465d; 
            --gold: #f0b90b; 
            --blue: #3b82f6; 
            --input-bg: #2b3139; 
            --gray: #848e9c;
        }
        
        * { box-sizing: border-box; }

        body { 
            background-color: var(--bg); color: var(--text); font-family: 'Noto Sans KR', sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 15px; 
        }
        
        .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
        .mono { font-family: 'Roboto Mono', monospace; }

        .card { 
            background-color: var(--card); border-radius: 12px; padding: 20px; 
            border: 1px solid #2b3139; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; 
        }
        
        .timer-bar {
            background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.4);
            color: var(--blue); padding: 10px 15px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;
        }

        .coin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .coin-symbol { font-size: 1.8rem; font-weight: 900; color: #fff; letter-spacing: 1px; line-height: 1; }
        .coin-sub { font-size: 0.8rem; color: var(--gray); font-weight: normal; margin-left: 5px; }
        .coin-select { background: var(--input-bg); color: #fff; border: 1px solid #444; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer; outline: none; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-box { background: #13161a; border: 1px solid #333; border-radius: 8px; padding: 12px; }
        .info-label { font-size: 0.75rem; color: var(--gray); margin-bottom: 4px; }
        .info-val { font-size: 1rem; font-weight: bold; color: #fff; white-space: nowrap; } 
        .info-sub { font-size: 0.7rem; color: #666; margin-top: 2px; }

        .price-row { display: flex; justify-content: space-between; align-items: end; margin-bottom: 15px; }

        .strategy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        
        .action-box { 
            text-align: center; padding: 20px 10px; border-radius: 8px; 
            background: rgba(0, 0, 0, 0.3); 
            border: 1px solid #444; 
            transition: 0.3s; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .action-box.long { border-color: rgba(14, 203, 129, 0.3); }
        .action-box.short { border-color: rgba(246, 70, 93, 0.3); }
        
        .action-box.long .box-title { color: var(--green); }
        .action-box.long .box-price { color: #fff; }
        
        .action-box.short .box-title { color: var(--red); }
        .action-box.short .box-price { color: #fff; }

        .action-box.long.active { 
            background: rgba(14, 203, 129, 0.1); 
            border: 2px solid var(--green); 
            box-shadow: 0 0 15px rgba(14, 203, 129, 0.2);
            transform: scale(1.02); 
        }
        .action-box.short.active { 
            background: rgba(246, 70, 93, 0.1); 
            border: 2px solid var(--red); 
            box-shadow: 0 0 15px rgba(246, 70, 93, 0.2);
            transform: scale(1.02); 
        }
        
        .box-title { font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; letter-spacing: 0.5px; }
        .box-price { font-size: 1.4rem; font-weight: bold; margin-bottom: 8px; letter-spacing: 0.5px; }
        
        .sl-label { 
            font-size: 0.8rem; 
            color: var(--red); 
            font-weight: bold; 
            background: rgba(255,255,255,0.05); 
            padding: 4px 8px; border-radius: 4px; display: inline-block; 
        }

        .badge-wrapper { margin-top: 10px; width: 100%; display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; }
        
        .trend-warning { 
            display: none; 
            background: transparent; 
            border: 1px solid var(--gold);
            color: var(--gold); 
            font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 4px; 
        }
        .trend-safe { 
            display: none; 
            background: transparent;
            border: 1px solid var(--green);
            color: var(--green);
            font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 4px; 
        }

        .wr-card { background: #161a1e; border: 1px solid #333; border-radius: 10px; padding: 20px; margin-top: 15px; }
        .wr-track { height: 10px; background: #2b3139; border-radius: 5px; width: 100%; position: relative; margin: 15px 0; overflow: hidden; }
        .wr-fill { height: 100%; width: 50%; border-radius: 5px; transition: width 0.5s ease; }
        .wr-line { position: absolute; top:0; bottom:0; width:1px; background: #555; z-index: 2; }
        
        .help-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 18px; height: 18px; border-radius: 50%;
            background-color: #333; color: #888; font-size: 12px; font-weight: bold;
            cursor: help; border: 1px solid #444; position: relative; margin-left: 4px;
        }
        .help-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); color: #fff; padding: 12px; border-radius: 8px;
            font-size: 0.8rem; white-space: pre-wrap; width: 220px;
            z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #555; pointer-events: none; text-align: left;
        }

        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.95rem; }
        .basic-input { background: var(--input-bg); color: #fff; border: 1px solid #444; padding: 8px; border-radius: 6px; width: 80px; text-align: center; font-weight: bold; font-size: 1rem; }
        
        .risk-result { background: #000; padding: 20px; border-radius: 8px; margin-top: 15px; border: 1px solid #444; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; border-top: 1px dashed #333; padding-top: 15px; }
        .res-box { text-align: center; }
        .res-label { font-size: 0.8rem; color: var(--gray); margin-bottom: 4px; }
        .res-val { font-size: 1rem; font-weight: bold; color: #fff; }
        .qty-big { font-size: 1.5rem; font-weight: bold; color: var(--gold); display: block; text-align: center; margin-bottom: 5px; }

        .footer-principles {
            margin-top: 30px; padding: 20px; background: #101216; border-top: 1px solid #333;
            border-radius: 8px; color: #888; font-size: 0.85rem; line-height: 1.6;
        }
        .footer-title { color: var(--gold); font-weight: bold; margin-bottom: 12px; font-size: 1rem; }
        .footer-list { list-style: none; padding: 0; margin: 0; }
        .footer-list li { position: relative; padding-left: 20px; margin-bottom: 8px; word-break: keep-all; line-height: 1.5; }
        .footer-list li::before { content: "â€¢"; color: var(--blue); font-weight: bold; position: absolute; left: 0; top: 0; }

        /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .summary-box { 
            border: 1px solid #333; border-radius: 8px; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.2);
        }
        .summary-header {
            font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 0.9rem;
        }
        .summary-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center;
        }
        .sum-label { font-size: 0.75rem; color: #aaa; margin-bottom: 4px; }
        .sum-val { font-size: 0.9rem; font-weight: bold; }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì„¸ê·¸ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤) */
        .tab-group {
            display: flex; background: #252a30; border-radius: 4px; padding: 2px; gap: 2px;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 4px 8px; font-size: 0.7rem; color: #848e9c; 
            cursor: pointer; border-radius: 3px; font-weight: 500; transition: all 0.2s;
        }
        .tab-btn.active {
            background: #3b82f6; color: #fff; font-weight: bold;
        }

        /* ìˆ˜ë™ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (ì´ì§ˆê° ì—†ì• ê¸°) */
        .seamless-input {
            width: 100%; background: transparent; border: none; 
            border-bottom: 1px dashed #555;
            color: #fff; font-size: 1rem; font-weight: bold; 
            font-family: 'Roboto Mono', monospace;
            padding: 0; margin: 0; outline: none;
            transition: border-color 0.2s;
        }
        .seamless-input:focus { border-bottom: 1px solid var(--blue); }

        @media (max-width: 480px) {
            .container { width: 100%; padding: 5px; }
            .card { padding: 15px; }
            .info-grid { grid-template-columns: 1fr; gap: 10px; }
            .coin-header { flex-direction: column; align-items: stretch; gap: 10px; }
            .coin-header > div { display: flex; justify-content: space-between; align-items: baseline; }
            .coin-select { width: 100%; text-align: center; padding: 12px; }
            .strategy-grid { grid-template-columns: 1fr; gap: 15px; }
            .action-box { padding: 25px 15px; }
            .box-title { font-size: 0.9rem; }
            .box-price { font-size: 1.6rem; }
            .res-grid { grid-template-columns: 1fr; gap: 15px; }
            .input-row { font-size: 0.9rem; }
            .help-icon:hover::after { left: auto; right: -50px; transform: none; width: 200px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center; margin-bottom:5px;">
        <h2 style="margin:0; font-family:'Roboto Mono'; letter-spacing: -1px;">ğŸ›ï¸ WilliamsClassic</h2>
    </div>

    <div class="timer-bar">
        <div style="display:flex; align-items:center;">
            <span>â³ 09:00 ë¦¬ì…‹</span>
        </div>
        <span id="countdown" class="timer-val mono">--:--:--</span>
    </div>

    <div class="card">
        <div class="coin-header">
            <div>
                <span id="coinSymbol" class="coin-symbol">BTC</span>
                <span class="coin-sub mono">/ USDT</span>
            </div>
            <select id="coinSelect" class="coin-select" onchange="resetData()">
                <option value="BTCUSDT">Bitcoin (BTC)</option>
                <option value="ETHUSDT">Ethereum (ETH)</option>
                <option value="SOLUSDT">Solana (SOL)</option>
                <option value="XRPUSDT">Ripple (XRP)</option>
            </select>
        </div>

        <div class="info-grid">
            <div class="info-box">
                <div class="info-label" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>Noise K Factor</span>
                    <div class="tab-group">
                        <div id="tabAuto" class="tab-btn active" onclick="setKMode('auto')">ìë™</div>
                        <div id="tabManual" class="tab-btn" onclick="setKMode('manual')">ìˆ˜ë™</div>
                    </div>
                </div>
                
                <div id="kAutoWrap">
                    <div id="kVal" class="info-val mono">0.50</div>
                </div>
                
                <div id="kManualWrap" style="display:none;">
                    <input type="number" id="kInput" class="seamless-input" value="0.5" step="0.05" oninput="recalcAnalysis()">
                </div>

                <div id="kMsg" class="info-sub">ë°ì´í„° ê³„ì‚° ì¤‘...</div>
            </div>

            <div class="info-box">
                <div class="info-label">
                    Market Trend (20MA)
                </div>
                <div id="trendVal" class="info-val mono">---</div>
                <div id="trendMsg" class="info-sub">ì¶”ì„¸ íŒŒì•… ì¤‘...</div>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <div class="price-row">
                <span style="font-size:0.85rem; color:var(--gray);">í˜„ì¬ê°€ (Current)</span>
                <span id="curPrice" class="mono" style="font-size:1.4rem; font-weight:bold;">---</span>
            </div>
        </div>

        <div class="strategy-grid">
            <div id="boxLong" class="action-box long">
                <div class="box-title">â–² LONG ENTRY PRICE</div>
                <div id="longTarget" class="box-price mono">---</div>
                <div class="sl-label">STOP LOSS: <span id="longSl" class="mono">---</span></div>
                <div class="badge-wrapper">
                    <div id="badgeLongSafe" class="trend-safe">âœ… í˜„ì¬ ì¶”ì„¸</div>
                    <div id="badgeLongRisk" class="trend-warning">âš ï¸ ì—­ì¶”ì„¸ ì£¼ì˜</div>
                </div>
            </div>
            <div id="boxShort" class="action-box short">
                <div class="box-title">â–¼ SHORT ENTRY PRICE</div>
                <div id="shortTarget" class="box-price mono">---</div>
                <div class="sl-label">STOP LOSS: <span id="shortSl" class="mono">---</span></div>
                <div class="badge-wrapper">
                    <div id="badgeShortSafe" class="trend-safe">âœ… í˜„ì¬ ì¶”ì„¸</div>
                    <div id="badgeShortRisk" class="trend-warning">âš ï¸ ì—­ì¶”ì„¸ ì£¼ì˜</div>
                </div>
            </div>
        </div>
        
        <div style="text-align:center; font-size:0.8rem; color:#fff; margin-top:10px; height:20px;">
            <span id="msg">ë°ì´í„° ìˆ˜ì‹  ëŒ€ê¸°...</span>
        </div>
    </div>

    <div class="wr-card">
        <div class="wr-header" style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; font-size:0.9rem;">ğŸ“‰ Williams %R (14)</span>
            <span id="wrVal" class="mono" style="font-weight:bold; font-size:1.1rem;">---</span>
        </div>
        <div class="wr-track">
            <div class="wr-line" style="left: 20%;"></div> 
            <div class="wr-line" style="left: 80%;"></div>
            <div id="wrFill" class="wr-fill" style="width: 0%; background: #555;"></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--gray); margin-top:5px;">
            <span style="color:var(--green); font-weight:bold;">â—€ ê³¼ë§¤ë„ (-80) Buy</span>
            <span style="color:var(--red); font-weight:bold;">ê³¼ë§¤ìˆ˜ (-20) Sell â–¶</span>
        </div>
        <div id="wrDesc" style="text-align:center; font-size:0.8rem; margin-top:10px; color:#ccc; line-height:1.4;">ë¶„ì„ ì¤‘...</div>
    </div>

    <div class="settings-card" style="margin-top:10px; background:#161a1e; border:1px solid #333; padding:20px; border-radius:10px;">
        <div style="font-weight:bold; color:#fff; margin-bottom:15px; font-size:1rem;">ğŸ’° ìê¸ˆ ê´€ë¦¬ (Risk Management)</div>
        <div class="input-row">
            <span>ë‚´ ì¦ê±°ê¸ˆ (USDT)</span>
            <input type="number" id="capital" placeholder="1000" class="basic-input" oninput="recalc()">
        </div>
        <div class="input-row">
            <span>í—ˆìš© ì†ì‹¤ (Risk %)</span>
            <input type="number" id="riskPer" value="2" class="basic-input" oninput="recalc()">
        </div>
        <div class="input-row">
            <span>ë ˆë²„ë¦¬ì§€ (Lev)</span>
            <input type="number" id="leverage" value="5" class="basic-input" oninput="recalc()">
        </div>
        
        <div class="risk-result">
            <div style="font-size:0.8rem; color:var(--gray); margin-bottom:5px;">â–¼ ì£¼ë¬¸ ìˆ˜ëŸ‰ (Qty) : Long/Short ë™ì¼</div>
            <div style="display:flex; justify-content:center; align-items:baseline; gap:5px;">
                <span id="coinQty" class="qty-big mono">---</span>
                <span id="qtyUnit" style="font-size:0.9rem; font-weight:bold; color:#ccc;">COIN</span>
            </div>
            
            <div class="res-grid">
                <div class="res-box">
                    <div class="res-label">LONG í•„ìš”ê¸ˆì•¡ (Cost)</div>
                    <div id="longCost" class="res-val mono">---</div>
                </div>
                <div class="res-box">
                    <div class="res-label">SHORT í•„ìš”ê¸ˆì•¡ (Cost)</div>
                    <div id="shortCost" class="res-val mono">---</div>
                </div>
            </div>
            <div style="font-size:0.7rem; color:#666; margin-top:10px; text-align:center; line-height:1.3;">
                * í˜„ì¬ê°€ê°€ ì•„ë‹Œ <b>ëª©í‘œ ì§„ì…ê°€</b> ê¸°ì¤€ìœ¼ë¡œ<br>ê³„ì‚°ëœ ì •í™•í•œ ê°’ì…ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <div class="card" style="margin-top:10px;">
        <div style="font-weight:bold; color:#fff; margin-bottom:15px; font-size:1rem;">âš¡ ê±°ë˜ì†Œ ì£¼ë¬¸ ìš”ì•½ (Order Summary)</div>
        
        <div class="summary-box" style="border-color: var(--green);">
            <div class="summary-header" style="color:var(--green);">â–² LONG ì£¼ë¬¸ (ë§¤ìˆ˜)</div>
            <div class="summary-grid">
                <div>
                    <div class="sum-label">ì§„ì…ê°€ (Entry)</div>
                    <div id="sumLongEntry" class="sum-val mono">---</div>
                </div>
                <div>
                    <div class="sum-label">ìˆ˜ëŸ‰ (Qty)</div>
                    <div id="sumLongQty" class="sum-val mono">---</div>
                </div>
                <div>
                    <div class="sum-label">ìŠ¤íƒ‘ë¡œìŠ¤ (SL)</div>
                    <div id="sumLongSl" class="sum-val mono" style="color:var(--red);">---</div>
                </div>
            </div>
        </div>

        <div class="summary-box" style="border-color: var(--red); margin-bottom: 0;">
            <div class="summary-header" style="color:var(--red);">â–¼ SHORT ì£¼ë¬¸ (ë§¤ë„)</div>
            <div class="summary-grid">
                <div>
                    <div class="sum-label">ì§„ì…ê°€ (Entry)</div>
                    <div id="sumShortEntry" class="sum-val mono">---</div>
                </div>
                <div>
                    <div class="sum-label">ìˆ˜ëŸ‰ (Qty)</div>
                    <div id="sumShortQty" class="sum-val mono">---</div>
                </div>
                <div>
                    <div class="sum-label">ìŠ¤íƒ‘ë¡œìŠ¤ (SL)</div>
                    <div id="sumShortSl" class="sum-val mono" style="color:var(--red);">---</div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-principles">
        <div class="footer-title">ğŸ“œ ë˜ë¦¬ ìœŒë¦¬ì—„ìŠ¤ì˜ íˆ¬ì ì›ì¹™</div>
        <ul class="footer-list">
            <li><b>ì˜ˆì¸¡í•˜ì§€ ë§ˆë¼:</b> ë‚˜ëŠ” ì‹œì¥ì´ ì–´ë””ë¡œ ê°ˆì§€ ëª¨ë¥¸ë‹¤. ë‹¨ì§€ í˜„ì¬ ê°€ê²©ì´ ë§í•´ì£¼ëŠ” ëŒ€ë¡œ ë°˜ì‘í•  ë¿ì´ë‹¤.</li>
            <li><b>ìê¸ˆ ê´€ë¦¬ê°€ ì „ë¶€ë‹¤:</b> ì•„ë¬´ë¦¬ ì¢‹ì€ ê¸°ë²•ë„ í•œ ë²ˆì˜ íŒŒì‚°ì„ ë§‰ì„ ìˆœ ì—†ë‹¤. ê³„ì¢Œì˜ 2% ì´ìƒ ìƒì§€ ë§ˆë¼.</li>
            <li><b>ì†ì ˆì€ ìƒëª…ì´ë‹¤:</b> ì†ì‹¤ì€ ì§§ê²Œ, ìˆ˜ìµì€ ê¸¸ê²Œ ê°€ì ¸ê°€ë¼. ì†ì ˆì´ ë‚˜ê°€ëŠ” ê±´ ì‹œìŠ¤í…œì´ ë‚˜ë¥¼ ì§€ì¼œì¤€ ê²ƒì´ë‹¤.</li>
            <li><b>ì¶”ì„¸ì— ìˆœì‘í•˜ë¼:</b> ë–¨ì–´ì§€ëŠ” ì¹¼ë‚ ì„ ì¡ì§€ ë§ˆë¼. í™•ì‹¤í•œ ëŒíŒŒê°€ ë‚˜ì˜¤ë©´ ê·¸ë•Œ ì˜¬ë¼íƒ€ë„ ëŠ¦ì§€ ì•Šë‹¤.</li>
        </ul>
    </div>
</div>

<script>
    let market = { current: 0, open: 0, range: 0, k: 0.5, ma20: 0 };
    let precision = 2;
    let globalLongPrice = 0;
    let globalShortPrice = 0;
    
    let globalData = null; 
    let currentKMode = 'auto'; // 'auto' or 'manual'

    resetData();
    setInterval(fetchData, 2000);
    setInterval(updateTimer, 1000);
    updateTimer();

    function resetData() {
        const select = document.getElementById('coinSelect');
        const symbolCode = select.value.replace('USDT', '');
        document.getElementById('coinSymbol').innerText = symbolCode;
        document.getElementById('qtyUnit').innerText = symbolCode;
        document.getElementById('msg').innerText = "ë°ì´í„° ë¶„ì„ ì¤‘...";
        globalData = null;
        fetchData();
    }

    // íƒ­ ë³€ê²½ í•¨ìˆ˜ (ì„¸ê·¸ë¨¼íŠ¸ ì»¨íŠ¸ë¡¤)
    function setKMode(mode) {
        currentKMode = mode;
        const autoWrap = document.getElementById('kAutoWrap');
        const manualWrap = document.getElementById('kManualWrap');
        const tabAuto = document.getElementById('tabAuto');
        const tabManual = document.getElementById('tabManual');
        
        if (mode === 'manual') {
            tabAuto.classList.remove('active');
            tabManual.classList.add('active');
            
            autoWrap.style.display = 'none';
            manualWrap.style.display = 'block';
            document.getElementById('kInput').focus();
        } else {
            tabAuto.classList.add('active');
            tabManual.classList.remove('active');
            
            autoWrap.style.display = 'block';
            manualWrap.style.display = 'none';
        }
        recalcAnalysis(); // ëª¨ë“œ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ê³„ì‚°
    }

    async function fetchData() {
        try {
            const symbol = document.getElementById('coinSelect').value;
            if(symbol.startsWith('BTC')) precision = 1;
            else if(symbol.startsWith('XRP')) precision = 4;
            else precision = 2;

            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=50`);
            const data = await res.json();
            if(!data || data.length < 50) throw new Error("API Error");

            globalData = data;
            recalcAnalysis();

        } catch(e) {
            console.error(e);
            document.getElementById('msg').innerText = "ì—°ê²° ì¬ì‹œë„ ì¤‘...";
        }
    }

    function recalcAnalysis() {
        if (!globalData) return;
        
        const data = globalData;
        const today = data[data.length - 1]; 
        const prev = data[data.length - 2]; 

        market.current = parseFloat(today[4]); 
        market.open = parseFloat(today[1]);    
        market.range = parseFloat(prev[2]) - parseFloat(prev[3]); 

        // ìë™ K ê³„ì‚°
        let noiseSum = 0;
        for(let i = data.length - 2; i > data.length - 2 - 20; i--) {
            const o = parseFloat(data[i][1]);
            const c = parseFloat(data[i][4]);
            const rng = parseFloat(data[i][2]) - parseFloat(data[i][3]);
            let noise = 0;
            if(rng > 0) noise = 1 - (Math.abs(c - o) / rng);
            noiseSum += noise;
        }
        const autoK = parseFloat((noiseSum / 20).toFixed(2));

        const kMsg = document.getElementById('kMsg');
        
        if (currentKMode === 'manual') {
            const val = parseFloat(document.getElementById('kInput').value);
            market.k = isNaN(val) ? 0.5 : val;
            kMsg.innerText = "ì‚¬ìš©ì ì„¤ì •ê°’ ì ìš©";
            kMsg.style.color = "var(--blue)";
            
            // Auto ê°’ë„ ì—…ë°ì´íŠ¸ëŠ” í•´ë‘  (í™”ë©´ ë’¤ì—ì„œ)
            document.getElementById('kVal').innerText = autoK.toFixed(2);
        } else {
            market.k = autoK;
            document.getElementById('kVal').innerText = market.k.toFixed(2);
            
            let statusText = "";
            let statusColor = "";
            
            if(market.k > 0.6) { 
                statusText = "í˜¼ì¡°ì„¸: Kê°’ ìƒí–¥ (ì•ˆì „)"; 
                statusColor = "var(--gold)"; 
            } else if(market.k < 0.4) { 
                statusText = "ì¶”ì„¸ì¥: Kê°’ í•˜í–¥ (ê³µê²©)"; 
                statusColor = "var(--green)"; 
            } else { 
                statusText = "í‘œì¤€ ë³€ë™ì„±"; 
                statusColor = "#666"; 
            }
            
            kMsg.innerHTML = `<span style="color:${statusColor}">${statusText}</span> <span style="color:#666; font-size:0.7rem;">/ 20ì¼ í‰ê· </span>`;
        }

        // MA20
        let closeSum = 0;
        for(let i = data.length - 2; i > data.length - 2 - 20; i--) {
            closeSum += parseFloat(data[i][4]);
        }
        market.ma20 = closeSum / 20;

        // WR
        let hh = -Infinity;
        let ll = Infinity;
        for(let i = data.length - 1; i > data.length - 1 - 14; i--) {
            const h = parseFloat(data[i][2]);
            const l = parseFloat(data[i][3]);
            if(h > hh) hh = h;
            if(l < ll) ll = l;
        }
        let wr = -50;
        if(hh !== ll) wr = ((hh - market.current) / (hh - ll)) * -100;

        updateUI(wr);
    }

    function updateUI(wr) {
        if(market.current === 0) return;

        document.getElementById('curPrice').innerText = market.current.toFixed(precision);
        
        const isBull = market.current > market.ma20;
        const trendVal = document.getElementById('trendVal');
        const trendMsg = document.getElementById('trendMsg');
        
        if(isBull) {
            trendVal.innerHTML = "<span style='color:var(--green)'>â–² ìƒìŠ¹ì¥ (Bull)</span>";
            trendMsg.innerText = "ë¡± ìœ ë¦¬ / ìˆ ì£¼ì˜";
        } else {
            trendVal.innerHTML = "<span style='color:var(--red)'>â–¼ í•˜ë½ì¥ (Bear)</span>";
            trendMsg.innerText = "ìˆ ìœ ë¦¬ / ë¡± ì£¼ì˜";
        }

        const longPrice = market.open + (market.range * market.k);
        const shortPrice = market.open - (market.range * market.k);
        
        globalLongPrice = longPrice;
        globalShortPrice = shortPrice;

        const slDist = market.range * 0.5;
        const longSl = longPrice - slDist;
        const shortSl = shortPrice + slDist;

        document.getElementById('longTarget').innerText = longPrice.toFixed(precision);
        document.getElementById('longSl').innerText = longSl.toFixed(precision);
        document.getElementById('shortTarget').innerText = shortPrice.toFixed(precision);
        document.getElementById('shortSl').innerText = shortSl.toFixed(precision);

        // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ê°€ê²© ë° ìŠ¤íƒ‘ë¡œìŠ¤)
        document.getElementById('sumLongEntry').innerText = longPrice.toFixed(precision);
        document.getElementById('sumLongSl').innerText = longSl.toFixed(precision);
        document.getElementById('sumShortEntry').innerText = shortPrice.toFixed(precision);
        document.getElementById('sumShortSl').innerText = shortSl.toFixed(precision);

        document.getElementById('badgeLongSafe').style.display = isBull ? 'inline-block' : 'none';
        document.getElementById('badgeLongRisk').style.display = isBull ? 'none' : 'inline-block';
        document.getElementById('badgeShortSafe').style.display = !isBull ? 'inline-block' : 'none';
        document.getElementById('badgeShortRisk').style.display = !isBull ? 'none' : 'inline-block';

        const boxLong = document.getElementById('boxLong');
        const boxShort = document.getElementById('boxShort');
        const msg = document.getElementById('msg');
        
        boxLong.classList.remove('active');
        boxShort.classList.remove('active');
        msg.innerText = "ëŒíŒŒ ëŒ€ê¸° ì¤‘...";
        msg.style.color = "#ccc";

        if(market.current >= longPrice) {
            boxLong.classList.add('active');
            msg.innerText = "ğŸš€ LONG ì§„ì… ì‹ í˜¸!";
            msg.style.color = "var(--green)";
        } else if(market.current <= shortPrice) {
            boxShort.classList.add('active');
            msg.innerText = "ğŸš€ SHORT ì§„ì… ì‹ í˜¸!";
            msg.style.color = "var(--red)";
        }

        let displayPercent = wr + 100; 
        const wrVal = document.getElementById('wrVal');
        const wrFill = document.getElementById('wrFill');
        const wrDesc = document.getElementById('wrDesc');

        wrVal.innerText = wr.toFixed(2);
        wrFill.style.width = displayPercent + "%";

        if(wr <= -80) { 
            wrFill.style.background = "var(--green)";
            wrVal.style.color = "var(--green)";
            wrDesc.innerHTML = "í˜„ì¬ <b style='color:var(--green)'>ê³¼ë§¤ë„</b> êµ¬ê°„ (ë§¤ìˆ˜ ê¸°íšŒ)";
        } else if(wr >= -20) { 
            wrFill.style.background = "var(--red)";
            wrVal.style.color = "var(--red)";
            wrDesc.innerHTML = "í˜„ì¬ <b style='color:var(--red)'>ê³¼ë§¤ìˆ˜</b> êµ¬ê°„ (ì²­ì‚°/ìˆ ê³ ë ¤)";
        } else {
            wrFill.style.background = "var(--blue)";
            wrVal.style.color = "#fff";
            wrDesc.innerText = "ì¤‘ë¦½ êµ¬ê°„";
        }

        recalc(); 
    }

    function recalc() {
        if(globalLongPrice === 0) return;
        calcRisk(globalLongPrice, globalShortPrice);
    }

    function calcRisk(longPrice, shortPrice) {
        const capital = parseFloat(document.getElementById('capital').value) || 0;
        const riskPer = parseFloat(document.getElementById('riskPer').value) || 2;
        const leverage = parseFloat(document.getElementById('leverage').value) || 1;
        
        const slDist = market.range * 0.5;
        if(slDist <= 0) return;

        const riskAmount = capital * (riskPer / 100);
        const coinQty = riskAmount / slDist;

        const costLong = (longPrice * coinQty) / leverage;
        const costShort = (shortPrice * coinQty) / leverage;

        const qtyFixed = coinQty.toFixed(4);
        document.getElementById('coinQty').innerText = qtyFixed;
        document.getElementById('longCost').innerText = Math.floor(costLong).toLocaleString() + " $";
        document.getElementById('shortCost').innerText = Math.floor(costShort).toLocaleString() + " $";
        
        // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸ (ìˆ˜ëŸ‰)
        document.getElementById('sumLongQty').innerText = qtyFixed;
        document.getElementById('sumShortQty').innerText = qtyFixed;

        const maxCost = Math.max(costLong, costShort);
        const qtyEl = document.getElementById('coinQty');
        
        if(maxCost > capital) {
            qtyEl.style.color = "var(--red)";
            qtyEl.innerText += " (ë¶€ì¡±!)";
        } else {
            qtyEl.style.color = "var(--gold)";
        }
    }

    function updateTimer() {
        const now = new Date();
        let target = new Date(now);
        target.setHours(9, 0, 0, 0); 
        if (now > target) target.setDate(target.getDate() + 1);
        const diff = target - now;
        const hh = Math.floor(diff / (1000 * 60 * 60));
        const mm = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const ss = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('countdown').innerText = `${hh<10?'0'+hh:hh}:${mm<10?'0'+mm:mm}:${ss<10?'0'+ss:ss}`;
    }
</script>
</body>
</html>
