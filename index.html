<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Williams Master V3.4</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0b0e11; 
            --card: #1e2329; 
            --text: #eaecef; 
            --green: #0ecb81; 
            --red: #f6465d; 
            --gold: #f0b90b; 
            --blue: #3b82f6; 
            --input-bg: #2b3139; 
            --gray: #848e9c;
        }
        
        body { 
            background-color: var(--bg); color: var(--text); font-family: 'Noto Sans KR', sans-serif; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 15px; 
        }
        
        .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }
        .mono { font-family: 'Roboto Mono', monospace; }

        .card { 
            background-color: var(--card); border-radius: 12px; padding: 25px; 
            border: 1px solid #2b3139; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; 
        }
        
        .timer-bar {
            background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.4);
            color: var(--blue); padding: 10px 15px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;
        }

        .coin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .coin-symbol { font-size: 2rem; font-weight: 900; color: #fff; letter-spacing: 1px; line-height: 1; }
        .coin-sub { font-size: 0.9rem; color: var(--gray); font-weight: normal; margin-left: 5px; }
        .coin-select { background: var(--input-bg); color: #fff; border: 1px solid #444; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .info-box { background: #13161a; border: 1px solid #333; border-radius: 8px; padding: 10px; }
        .info-label { font-size: 0.75rem; color: var(--gray); margin-bottom: 4px; }
        .info-val { font-size: 0.95rem; font-weight: bold; color: #fff; white-space: nowrap; overflow: visible; } 
        .info-sub { font-size: 0.7rem; color: #666; margin-top: 2px; }

        .strategy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        .action-box { 
            text-align: center; padding: 15px 8px; border-radius: 8px; 
            background: #13161a; border: 1px solid #333; transition: 0.3s; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .action-box.long { border-color: #1e3a2f; color: #6db695; }
        .action-box.short { border-color: #3a1e22; color: #b66d74; }
        
        .action-box.long.active { background: rgba(14, 203, 129, 0.2); border-color: var(--green); color: var(--green); transform: scale(1.02); }
        .action-box.short.active { background: rgba(246, 70, 93, 0.2); border-color: var(--red); color: var(--red); transform: scale(1.02); }
        
        .box-title { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; }
        .box-price { font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; letter-spacing: 0.5px; }
        
        .sl-label { 
            font-size: 0.85rem; color: var(--red); font-weight: bold; 
            background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; display: inline-block; 
        }

        .badge-wrapper { margin-top: 8px; width: 100%; display: flex; justify-content: center; }
        .trend-warning { display: none; background: var(--gold); color: #000; font-size: 0.75rem; font-weight: bold; padding: 3px 8px; border-radius: 4px; }
        .trend-safe { display: none; background: #333; color: #aaa; font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; }

        .wr-card { background: #161a1e; border: 1px solid #333; border-radius: 10px; padding: 15px; margin-top: 15px; }
        .wr-track { height: 8px; background: #2b3139; border-radius: 4px; width: 100%; position: relative; margin: 10px 0; overflow: hidden; }
        .wr-fill { height: 100%; width: 50%; border-radius: 4px; transition: width 0.5s ease; }
        .wr-line { position: absolute; top:0; bottom:0; width:1px; background: #555; z-index: 2; }
        
        .help-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%;
            background-color: #333; color: #888; font-size: 11px; font-weight: bold;
            cursor: help; border: 1px solid #444; position: relative; margin-left: 4px;
        }
        .help-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); color: #fff; padding: 10px 12px; border-radius: 6px;
            font-size: 0.8rem; white-space: pre-wrap; width: max-content; max-width: 250px;
            z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #555; pointer-events: none; text-align: left;
        }

        .input-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .basic-input { background: var(--input-bg); color: #fff; border: 1px solid #444; padding: 6px; border-radius: 4px; width: 70px; text-align: center; font-weight: bold; }
        
        .risk-result { background: #000; padding: 12px; border-radius: 6px; text-align: center; margin-top: 10px; border: 1px solid #444; }
        .risk-val { font-size: 1.2rem; font-weight: bold; color: var(--gold); display: block; margin-top: 5px; }
        .qty-val { border-top: 1px dashed #333; margin-top: 8px; padding-top: 8px; font-size: 0.9rem; color: #ccc; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">üèõÔ∏è Williams V3.4 <span style="font-size:0.8rem; color:var(--gold);">Final</span></h2>
        <div class="mono" style="font-size:0.75rem; color:var(--gray);">Logic Corrected</div>
    </div>

    <div class="timer-bar">
        <div style="display:flex; align-items:center;">
            <span>‚è≥ 09:00 Î¶¨ÏÖã</span>
        </div>
        <span id="countdown" class="timer-val mono">--:--:--</span>
    </div>

    <div class="card">
        <div class="coin-header">
            <div>
                <div id="coinSymbol" class="coin-symbol">BTC</div>
                <div class="coin-sub mono">/ USDT</div>
            </div>
            <select id="coinSelect" class="coin-select" onchange="resetData()">
                <option value="BTCUSDT">Bitcoin</option>
                <option value="ETHUSDT">Ethereum</option>
                <option value="SOLUSDT">Solana</option>
                <option value="XRPUSDT">Ripple</option>
            </select>
        </div>

        <div class="info-grid">
            <div class="info-box">
                <div class="info-label">
                    Dynamic K (20Ïùº ÎÖ∏Ïù¥Ï¶à)
                </div>
                <div id="kVal" class="info-val mono">0.50</div>
                <div id="kMsg" class="info-sub">Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ Ï§ë...</div>
            </div>
            <div class="info-box">
                <div class="info-label">
                    Market Trend (20MA)
                </div>
                <div id="trendVal" class="info-val mono">---</div>
                <div id="trendMsg" class="info-sub">Ï∂îÏÑ∏ ÌååÏïÖ Ï§ë...</div>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <div class="price-row" style="display:flex; justify-content:space-between; align-items:end;">
                <span style="font-size:0.85rem; color:var(--gray);">ÌòÑÏû¨Í∞Ä (Current)</span>
                <span id="curPrice" class="mono" style="font-size:1.4rem; font-weight:bold;">---</span>
            </div>
        </div>

        <div class="strategy-grid">
            <div id="boxLong" class="action-box long">
                <div class="box-title">‚ñ≤ LONG Breakout</div>
                <div id="longTarget" class="box-price mono">---</div>
                <div class="sl-label">STOP: <span id="longSl" class="mono">---</span></div>
                <div class="badge-wrapper">
                    <div id="badgeLongSafe" class="trend-safe">ÏàúÎ∞©Ìñ• (Safe)</div>
                    <div id="badgeLongRisk" class="trend-warning">‚ö†Ô∏è Ïó≠Ï∂îÏÑ∏ Ï£ºÏùò</div>
                </div>
            </div>
            <div id="boxShort" class="action-box short">
                <div class="box-title">‚ñº SHORT Breakout</div>
                <div id="shortTarget" class="box-price mono">---</div>
                <div class="sl-label">STOP: <span id="shortSl" class="mono">---</span></div>
                <div class="badge-wrapper">
                    <div id="badgeShortSafe" class="trend-safe">ÏàúÎ∞©Ìñ• (Safe)</div>
                    <div id="badgeShortRisk" class="trend-warning">‚ö†Ô∏è Ïó≠Ï∂îÏÑ∏ Ï£ºÏùò</div>
                </div>
            </div>
        </div>
        
        <div style="text-align:center; font-size:0.8rem; color:#fff; margin-top:10px; height:20px;">
            <span id="msg">Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÎåÄÍ∏∞...</span>
        </div>
    </div>

    <div class="wr-card">
        <div class="wr-header">
            <span style="font-weight:bold; font-size:0.9rem;">üìâ Williams %R (14)</span>
            <span id="wrVal" class="mono" style="font-weight:bold; font-size:1.1rem;">---</span>
        </div>
        <div class="wr-track">
            <div class="wr-line" style="left: 20%;"></div> 
            <div class="wr-line" style="left: 80%;"></div>
            <div id="wrFill" class="wr-fill" style="width: 0%; background: #555;"></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--gray); margin-top:5px;">
            <span style="color:var(--green); font-weight:bold;">‚óÄ Í≥ºÎß§ÎèÑ (-80Ïù¥Ìïò) Buy</span>
            <span style="color:var(--red); font-weight:bold;">Í≥ºÎß§Ïàò (-20Ïù¥ÏÉÅ) Sell ‚ñ∂</span>
        </div>
        <div id="wrDesc" style="text-align:center; font-size:0.8rem; margin-top:8px; color:#ccc;">Î∂ÑÏÑù Ï§ë...</div>
    </div>

    <div class="settings-card" style="margin-top:10px; background:#161a1e; border:1px solid #333; padding:15px; border-radius:10px;">
        <div style="font-weight:bold; color:#fff; margin-bottom:10px;">üí∞ ÏûêÍ∏à Í¥ÄÎ¶¨ (Risk Management)</div>
        <div class="input-row">
            <span>ÎÇ¥ Ï¶ùÍ±∞Í∏à (Total USDT)</span>
            <input type="number" id="capital" placeholder="1000" class="basic-input" style="width:80px;" oninput="calcRisk()">
        </div>
        <div class="input-row">
            <span>ÌóàÏö© ÏÜêÏã§ (Risk %)</span>
            <input type="number" id="riskPer" value="2" class="basic-input" oninput="calcRisk()">
        </div>
        <div class="input-row">
            <span>Î†àÎ≤ÑÎ¶¨ÏßÄ (Leverage)</span>
            <input type="number" id="leverage" value="5" class="basic-input" oninput="calcRisk()">
        </div>
        
        <div class="risk-result">
            <div style="display:flex; justify-content:center; gap:5px; align-items:center;">
                <span style="font-size:0.8rem; color:var(--gray);">Ï£ºÎ¨∏ Í∞ÄÎä• Í∏àÏï° (Cost)</span>
                <span class="help-icon" data-tooltip="Î†àÎ≤ÑÎ¶¨ÏßÄÍπåÏßÄ Î∞òÏòÅÎêú Ïã§Ï†ú Ï£ºÎ¨∏(Margin) Í∏àÏï°ÏûÖÎãàÎã§.&#10;Total Position = Cost √ó Leverage">?</span>
            </div>
            <span id="recMargin" class="risk-val mono">--- USDT</span>

            <div class="qty-val">
                <span style="font-size:0.8rem;">ÏΩîÏù∏ ÏàòÎüâ (Qty) = Cost √ó Lev / Price</span>
                <div style="margin-top:5px;">
                    ‚âà <span id="coinQty" class="mono" style="color:#fff; font-weight:bold; font-size:1.1rem;">---</span>
                    <span id="qtyUnit" style="font-size:0.8rem;">COIN</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let market = { current: 0, open: 0, range: 0, k: 0.5, ma20: 0 };
    let precision = 2;

    resetData();
    setInterval(fetchData, 2000);
    setInterval(updateTimer, 1000);
    updateTimer();

    function resetData() {
        const select = document.getElementById('coinSelect');
        const symbolCode = select.value.replace('USDT', '');
        document.getElementById('coinSymbol').innerText = symbolCode;
        document.getElementById('qtyUnit').innerText = symbolCode;
        document.getElementById('msg').innerText = "Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...";
        fetchData();
    }

    async function fetchData() {
        try {
            const symbol = document.getElementById('coinSelect').value;
            if(symbol.startsWith('BTC')) precision = 1;
            else if(symbol.startsWith('XRP')) precision = 4;
            else precision = 2;

            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=50`);
            const data = await res.json();
            if(!data || data.length < 50) throw new Error("API Error");

            const today = data[data.length - 1]; 
            const prev = data[data.length - 2]; 

            market.current = parseFloat(today[4]); 
            market.open = parseFloat(today[1]);    
            market.range = parseFloat(prev[2]) - parseFloat(prev[3]); 

            let noiseSum = 0;
            for(let i = data.length - 2; i > data.length - 2 - 20; i--) {
                const o = parseFloat(data[i][1]);
                const c = parseFloat(data[i][4]);
                const rng = parseFloat(data[i][2]) - parseFloat(data[i][3]);
                let noise = 0;
                if(rng > 0) noise = 1 - (Math.abs(c - o) / rng);
                noiseSum += noise;
            }
            market.k = parseFloat((noiseSum / 20).toFixed(2));

            let closeSum = 0;
            for(let i = data.length - 2; i > data.length - 2 - 20; i--) {
                closeSum += parseFloat(data[i][4]);
            }
            market.ma20 = closeSum / 20;

            let hh = -Infinity;
            let ll = Infinity;
            for(let i = data.length - 1; i > data.length - 1 - 14; i--) {
                const h = parseFloat(data[i][2]);
                const l = parseFloat(data[i][3]);
                if(h > hh) hh = h;
                if(l < ll) ll = l;
            }
            let wr = -50;
            if(hh !== ll) wr = ((hh - market.current) / (hh - ll)) * -100;

            updateUI(wr);
        } catch(e) {
            console.error(e);
            document.getElementById('msg').innerText = "Ïó∞Í≤∞ Ïû¨ÏãúÎèÑ Ï§ë...";
        }
    }

    function updateUI(wr) {
        if(market.current === 0) return;

        document.getElementById('curPrice').innerText = market.current.toFixed(precision);
        document.getElementById('kVal').innerText = market.k.toFixed(2);
        
        const kMsg = document.getElementById('kMsg');
        if(market.k > 0.6) { kMsg.innerText = "ÌòºÏ°∞ÏÑ∏: KÍ∞í ÏÉÅÌñ• (ÏïàÏ†Ñ)"; kMsg.style.color="var(--gold)"; }
        else if(market.k < 0.4) { kMsg.innerText = "Ï∂îÏÑ∏Ïû•: KÍ∞í ÌïòÌñ• (Í≥µÍ≤©)"; kMsg.style.color="var(--green)"; }
        else { kMsg.innerText = "ÌëúÏ§Ä Î≥ÄÎèôÏÑ±"; kMsg.style.color="#666"; }

        const isBull = market.current > market.ma20;
        const trendVal = document.getElementById('trendVal');
        const trendMsg = document.getElementById('trendMsg');
        
        if(isBull) {
            trendVal.innerHTML = "<span style='color:var(--green)'>‚ñ≤ ÏÉÅÏäπÏû• (Bull)</span>";
            trendMsg.innerText = "Î°± Ïú†Î¶¨ / Ïàè Ï£ºÏùò";
        } else {
            trendVal.innerHTML = "<span style='color:var(--red)'>‚ñº ÌïòÎùΩÏû• (Bear)</span>";
            trendMsg.innerText = "Ïàè Ïú†Î¶¨ / Î°± Ï£ºÏùò";
        }

        const longPrice = market.open + (market.range * market.k);
        const shortPrice = market.open - (market.range * market.k);
        const slDist = market.range * 0.5;
        const longSl = longPrice - slDist;
        const shortSl = shortPrice + slDist;

        document.getElementById('longTarget').innerText = longPrice.toFixed(precision);
        document.getElementById('longSl').innerText = longSl.toFixed(precision);
        document.getElementById('shortTarget').innerText = shortPrice.toFixed(precision);
        document.getElementById('shortSl').innerText = shortSl.toFixed(precision);

        document.getElementById('badgeLongSafe').style.display = isBull ? 'inline-block' : 'none';
        document.getElementById('badgeLongRisk').style.display = isBull ? 'none' : 'inline-block';
        document.getElementById('badgeShortSafe').style.display = !isBull ? 'inline-block' : 'none';
        document.getElementById('badgeShortRisk').style.display = !isBull ? 'none' : 'inline-block';

        const boxLong = document.getElementById('boxLong');
        const boxShort = document.getElementById('boxShort');
        const msg = document.getElementById('msg');
        
        boxLong.classList.remove('active');
        boxShort.classList.remove('active');
        msg.innerText = "ÎèåÌåå ÎåÄÍ∏∞ Ï§ë...";
        msg.style.color = "#ccc";

        if(market.current >= longPrice) {
            boxLong.classList.add('active');
            msg.innerText = "üöÄ LONG ÏßÑÏûÖ Ïã†Ìò∏!";
            msg.style.color = "var(--green)";
        } else if(market.current <= shortPrice) {
            boxShort.classList.add('active');
            msg.innerText = "üöÄ SHORT ÏßÑÏûÖ Ïã†Ìò∏!";
            msg.style.color = "var(--red)";
        }

        let displayPercent = wr + 100; 
        const wrVal = document.getElementById('wrVal');
        const wrFill = document.getElementById('wrFill');
        const wrDesc = document.getElementById('wrDesc');

        wrVal.innerText = wr.toFixed(2);
        wrFill.style.width = displayPercent + "%";

        if(wr <= -80) { 
            wrFill.style.background = "var(--green)";
            wrVal.style.color = "var(--green)";
            wrDesc.innerHTML = "ÌòÑÏû¨ <b style='color:var(--green)'>Í≥ºÎß§ÎèÑ</b> Íµ¨Í∞Ñ (Îß§Ïàò Í∏∞Ìöå)";
        } else if(wr >= -20) { 
            wrFill.style.background = "var(--red)";
            wrVal.style.color = "var(--red)";
            wrDesc.innerHTML = "ÌòÑÏû¨ <b style='color:var(--red)'>Í≥ºÎß§Ïàò</b> Íµ¨Í∞Ñ (Ï≤≠ÏÇ∞/Ïàè Í≥†Î†§)";
        } else {
            wrFill.style.background = "var(--blue)";
            wrVal.style.color = "#fff";
            wrDesc.innerText = "Ï§ëÎ¶Ω Íµ¨Í∞Ñ";
        }

        calcRisk();
    }

    // [ÏàòÏ†ïÎê®] ÏûêÍ∏à Í¥ÄÎ¶¨ Î°úÏßÅ Í≥µÏãù ÏàòÏ†ï
    function calcRisk() {
        const capital = parseFloat(document.getElementById('capital').value) || 0;
        const riskPer = parseFloat(document.getElementById('riskPer').value) || 2;
        const leverage = parseFloat(document.getElementById('leverage').value) || 1;
        
        if(market.current === 0) return;

        // 1. ÏÜêÏ†àÌè≠ Í≥ÑÏÇ∞ (ÏúåÎ¶¨ÏóÑÏä§: Range * 0.5)
        const slDist = market.range * 0.5;
        const slPercent = slDist / market.current; // Ïòà: 0.01 (1%)

        // 2. Î¶¨Ïä§ÌÅ¨ Í∏àÏï° (ÎÇ¥Í∞Ä ÏûÉÏùÑ Í∞ÅÏò§Í∞Ä Îêú Îèà)
        const riskAmount = capital * (riskPer / 100);

        // 3. Ï¥ù Ìè¨ÏßÄÏÖò Í∑úÎ™® (Position Size) = Î¶¨Ïä§ÌÅ¨ Í∏àÏï° / ÏÜêÏ†à%
        // "Ïù¥ÎßåÌÅº ÏÇ¨Ïïº ÏÜêÏ†àÎÇ¨ÏùÑ Îïå Îî± 2%Îßå ÏûÉÎäîÎã§"
        const positionSizeUSDT = riskAmount / slPercent;

        // 4. Ï£ºÎ¨∏ Í∞ÄÎä• Í∏àÏï° (Cost) = Ï¥ù Ìè¨ÏßÄÏÖò / Î†àÎ≤ÑÎ¶¨ÏßÄ
        // "Î†àÎ≤ÑÎ¶¨ÏßÄÎ•º Ïì∞ÎãàÍπå ÎÇ¥ ÏßÄÍ∞ëÏóêÏÑúÎäî Ïù¥ÎßåÌÅºÎßå ÎÇòÍ∞ÑÎã§"
        const requiredMargin = positionSizeUSDT / leverage;

        // 5. ÏΩîÏù∏ Í∞úÏàò (Qty) = (Cost * Leverage) / Price
        // "Í≤∞Íµ≠ ÎÇ¥Í∞Ä Ï£ºÎ¨∏Ï∞ΩÏóê ÏûÖÎ†•Ìï† ÏΩîÏù∏ Í∞úÏàòÎäî?"
        // Cost * LeverageÎäî Í≤∞Íµ≠ Position SizeÏôÄ Í∞ôÏùå
        const coinQty = (requiredMargin * leverage) / market.current;

        const marginEl = document.getElementById('recMargin');
        marginEl.innerText = Math.floor(requiredMargin).toLocaleString() + " USDT";
        
        document.getElementById('coinQty').innerText = coinQty.toFixed(4);

        if(requiredMargin > capital) {
            marginEl.style.color = "var(--red)";
            marginEl.innerText += " (Î∂ÄÏ°±!)";
        } else {
            marginEl.style.color = "var(--gold)";
        }
    }

    function updateTimer() {
        const now = new Date();
        let target = new Date(now);
        target.setHours(9, 0, 0, 0); 
        if (now > target) target.setDate(target.getDate() + 1);
        const diff = target - now;
        const hh = Math.floor(diff / (1000 * 60 * 60));
        const mm = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const ss = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('countdown').innerText = `${hh<10?'0'+hh:hh}:${mm<10?'0'+mm:mm}:${ss<10?'0'+ss:ss}`;
    }
</script>
</body>
</html>
